---
title: "lab_09"
author: "derek willis"
date: "10/26/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## You will need

* A Census API key

## Load libraries and establish settings

**Task** Create a codeblock and load appropriate packages and settings for this lab. We'll be making some charts and using Census data.

```{r}
# Turn off scientific notation
options(scipen=999)

# Load the tidyverse.
library(tidyverse)
library(tidycensus)
library(janitor)

# Establish API Key for Census
census_api_key("549950d36c22ff16455fe196bbbd01d63cfbe6cf")

```

## Load data

**Task** Create a codeblock and load the following data from the data folder:

* Maryland active registered voters - `md_active_voters.csv`
* Maryland absentee ballots sent and returned - `md_absentee_ballots.csv`

You may want to clean up the column names and standardize the names of counties so that they appear identical in the two dataframes.


```{r}
md_active_voters <- read_csv("data/md_active_voters.csv")
md_absentee_ballots <- read_csv("data/md_absentee_ballots.csv") %>% clean_names() %>% mutate(county_name = str_to_title(county_name), geoid = as.character(geoid))
```

## Questions 

**Q1.** Which county has the highest percentage of total absentee ballots returned of total ballots sent? Make a bar chart of the top 10 counties. Your bar chart must have:

* A clear title that states the main idea/finding
* Good labels for the x & y axis and a caption for the source, which is the Maryland State Board of Elections
* Readable bars - the values shouldn't be overlapping

**A1.** 

```{r}
# Calculate the percentage
md_absentee_ballots <- md_absentee_ballots %>%
  mutate(pct_returned = total_received/total_sent*100) %>% 
  arrange(desc(pct_returned))

# Plot the data.  Use geom_line to draw the line, geom_point to add points, geom_text to add labels.  Use scale_x_date to set breaks at 1 day. 
md_absentee_ballots %>%
  head(10) %>% 
  ggplot() + 
  geom_bar(aes(x=reorder(county_name,pct_returned), weight=pct_returned)) + 
  coord_flip() +
  labs(
    title="Smaller Maryland Counties Returning More Absentee Ballots",
    y = "percentage of ballots returned",
    x = "county",
    caption = "source: Maryland State Board of Elections"
  )

```

**Q2.** What are the top 10 counties with the lowest percentage of ballots returned by Democratic voters, and what is the difference between the percentage returned for Democrats and Republicans in those counties? You MUST do the following things when answering this question:

* Make a codeblock below to write your code in.
* Calculate the percentage of ballots returned by both Democrats and Republicans.
* Arrange the dataframe to show the counties with the smallest percentage of returned ballots from Democrats first.
* Use ggplot to make a horizontal bar chart that shows just the first 10 counties, with the length of the bar determined by the county's percentage of ballots returned by Democrats. Give it an appropriate title, source, and x and y axis titles. 

**A2.** 
```{r}
md_absentee_ballots <- md_absentee_ballots %>%
  mutate(pct_returned_dem = dem_received/dem_sent*100, pct_returned_rep = rep_received/rep_sent*100, pct_returned_oth = oth_received/oth_sent*100, dem_rep_diff = pct_returned_dem-pct_returned_rep) %>% 
  arrange(pct_returned_dem)

md_absentee_ballots %>% 
  head(10) %>% 
  ggplot() + 
  geom_bar(aes(x=reorder(county_name,-pct_returned_dem), weight=pct_returned_dem)) + 
  coord_flip() +
  labs(
    title="Maryland's Largest Counties Returning Fewer Absentee Ballots",
    y = "percentage of ballots returned",
    x = "county",
    caption = "source: Maryland State Board of Elections"
  )

```

**Q3.**  A scatterplot is a type of chart that helps us see relationships between two variables. One variable goes on the x axis, the other on the y axis.  For each row/observation in our data, a scatterplot puts a circle (or a "point") where the two variables intersect on a grid. 

Statisticians use scatterplots to show graphically whether one variable is correlated -- related, in a statistical sense -- with another variable.  A classic example is the [relationship between ice cream sales and temperature](https://www.mathsisfun.com/data/scatter-xy-plots.html). The scatterplot below -- press play to load the image -- shows that relationship, that an increase in temperature is associated with an increase in ice cream sales. When it's 12C, sales are 200 dollars, and when it's hotter, 25C, sales are 600 dollars.

```{r}
knitr::include_graphics("https://www.mathsisfun.com/data/images/scatter-ice-cream1.svg")
```

We're going to use a scatterplot a little differently, to get a visual sense of two key variables: the percentage of absentee ballots returned by Republican voters in each county, and the percentage of people 65 and older in each county (using Census API data). We'll use them to answer some questions in a broad sense about absentee ballots and Maryland Republicans. This is just a jumping off point for further exploration. 

Our questions include: Does the percentage of returned ballots by Republicans vary depending on the percentage of older residents? Which counties see  Republicans returning a greater percentage of absentee ballots and which do not?

To answer those questions, do the following:

1. Load in the early voting CSV data produced by the state that is located here: https://elections.maryland.gov/press_room/2022_stats/GG22/EarlyVoting%20RAW%20data.csv.

2. Calculate the percentage of registered Republicans in each county.
3. Use tidycensus to create a dataframe with the total population of each Maryland county and its population aged 65 and over. You should include both variables in your get_acs() function and use `output="wide"` to make it easy to calculate a percentage.
4. Join the Census dataframe to your combined MD dataframe using GEOID.
4. Make a scatterplot showing the percentage of ballots returned by Republicans in each county on one axis and the percentage of residents 65+ in each county on the other axis. I didn't show you how to do this, so look it up! Googling "ggplot scatterplot" is a good start.
4. Give it an appropriate title, source, and x and y axis titles.
5. Add a label for each point that shows the name of the county using geom_text(). Try to make the names as easy to read as possible.
6. In the answer space below, describe what you see and answer the questions posed above. In a general sense, what do you think this means?  

**A3.**  

```{r}
md_early_voting <- read_csv("https://elections.maryland.gov/press_room/2022_stats/GG22/EarlyVoting%20RAW%20data.csv")
  
md_older_population <- get_acs(geography = "county",
                               variables = c('total_pop' = 'B01001_001', '65_plus' ="B16004_046"),
                               year = 2020,
                               state = 'MD',
                               output = 'wide'
                               )

md_older_population <- md_older_population %>% 
  mutate(pct_65plus = `65_plusE`/total_popE *100)

md_ballots_and_pop <- md_ballots_and_voters %>% 
  inner_join(md_older_population, by=c('geoid'='GEOID'))


# Plot it using geom_point.
md_ballots_and_pop %>%
  ggplot() +
  geom_point(aes(x=pct_65plus,y=pct_returned_rep)) +
  geom_text(aes(x=pct_65plus,y=pct_returned_rep, label=county_name), vjust=1) +
  labs(
    title="Maryland Counties with Older Populations Return Absentee Ballots Faster",
    y = "percentage of ballots returned",
    x = "percent 65+ population",
    caption = "source: Maryland State Board of Elections"
  )
```
